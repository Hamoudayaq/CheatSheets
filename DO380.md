---
layout: default
---

Text can be **bold**, _italic_, or ~~strikethrough~~.
<a href="./" class="btn">RHCSA</a><br>
<a href="./another-page.html" class="btn">Back</a><br>
<a href="./helm.html" class="btn">Helm</a><br>
<a href="./ex294.html" class="btn">EX294</a><br>

  <div class="container">
    <header>
      <h1>LDAP Authentication and group sync</h1>
      <p class="badge">Objective: Deploy/update apps from OpenShift templates</p>
    </header>


<pre class="screen fileinput">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: <code class="code">ldapidp</code> <a id="_update_the_oauth_cr-CO5-1"></a><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span>
    mappingMethod: <code class="code">claim</code> <a id="_update_the_oauth_cr-CO5-2"></a><span><img alt="2" border="0" src="/rol/static/roc/Common_Content/images/2.svg" class="image-previewer__preview "></span>
    type: LDAP
    ldap:
      attributes:
        id: <a id="_update_the_oauth_cr-CO5-3"></a><span><img alt="3" border="0" src="/rol/static/roc/Common_Content/images/3.svg" class="image-previewer__preview "></span>
        - <code class="code">dn</code>
        email: <a id="_update_the_oauth_cr-CO5-4"></a><span><img alt="4" border="0" src="/rol/static/roc/Common_Content/images/4.svg" class="image-previewer__preview "></span>
        - <code class="code">mail</code>
        name: <a id="_update_the_oauth_cr-CO5-5"></a><span><img alt="5" border="0" src="/rol/static/roc/Common_Content/images/5.svg" class="image-previewer__preview "></span>
        - <code class="code">cn</code>
        preferredUsername: <a id="_update_the_oauth_cr-CO5-6"></a><span><img alt="6" border="0" src="/rol/static/roc/Common_Content/images/6.svg" class="image-previewer__preview "></span>
        - <code class="code">uid</code>
      bindDN: <code class="code">'cn=administrator,dc=example,dc=com'</code> <a id="_update_the_oauth_cr-CO5-7"></a><span><img alt="7" border="0" src="/rol/static/roc/Common_Content/images/7.svg" class="image-previewer__preview "></span>
      bindPassword: <a id="_update_the_oauth_cr-CO5-8"></a><span><img alt="8" border="0" src="/rol/static/roc/Common_Content/images/8.svg" class="image-previewer__preview "></span>
        name: <code class="code">ldap-secret</code>
      <code class="code">ca</code>: <a id="_update_the_oauth_cr-CO5-9"></a><span><img alt="9" border="0" src="/rol/static/roc/Common_Content/images/9.svg" class="image-previewer__preview "></span>
        name: ca-config-map
      insecure: <code class="code">false</code> <a id="_update_the_oauth_cr-CO5-10"></a><span><img alt="10" border="0" src="/rol/static/roc/Common_Content/images/10.svg" class="image-previewer__preview "></span>
      url: "<code class="code">ldaps://ldaps.example.com/ou=users,dc=acme,dc=com?uid</code>" <a id="_update_the_oauth_cr-CO5-11"></a><span><img alt="11" border="0" src="/rol/static/roc/Common_Content/images/11.svg" class="image-previewer__preview "></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-1"><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>Provider names are shown on the web console login screen and in the list of configured IdPs.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-2"><span><img alt="2" border="0" src="/rol/static/roc/Common_Content/images/2.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>Controls how mappings are established between this provider's identities and user objects.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-3"><span><img alt="3" border="0" src="/rol/static/roc/Common_Content/images/3.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>List of attributes where the first non-empty attribute is used.
At least one attribute is required.
If none of the listed attributes has a value, then authentication fails.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-4"><span><img alt="4" border="0" src="/rol/static/roc/Common_Content/images/4.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>List of attributes to use as the email address.
The first non-empty attribute is used.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-5"><span><img alt="5" border="0" src="/rol/static/roc/Common_Content/images/5.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>List of attributes to use as the display name.
The first non-empty attribute is used.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-6"><span><img alt="6" border="0" src="/rol/static/roc/Common_Content/images/6.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>List of attributes to use as the preferred username when provisioning a user for this identity.
The first non-empty attribute is used.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-7"><span><img alt="7" border="0" src="/rol/static/roc/Common_Content/images/7.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>Required DN that is used during the search phase, unless anonymous searches are allowed.
Must be set if the <code class="code">bindPassword</code> parameter is defined.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-8"><span><img alt="8" border="0" src="/rol/static/roc/Common_Content/images/8.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>Required OpenShift secret resource that contains the bind password, unless anonymous searches are allowed.
Must be set if the <code class="code">bindDN</code> parameter is defined.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-9"><span><img alt="9" border="0" src="/rol/static/roc/Common_Content/images/9.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>Optional: Reference to an OpenShift configuration map resource that contains the privacy enhanced mail (PEM) encoded certificate authority bundle to validate server certificates for the configured URL.
Used only when the insecure option is false.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-10"><span><img alt="10" border="0" src="/rol/static/roc/Common_Content/images/10.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>When true, no TLS connection is made to the server.
When false, <code class="code">ldaps://</code> URLs connect by using TLS, and <code class="code">ldap://</code> URLs are upgraded to TLS.
The <code class="code">insecure</code> option must be set to false when <code class="code">ldaps://</code> URLs are in use, because these URLs always attempt to connect by using TLS.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_update_the_oauth_cr-CO5-11"><span><img alt="11" border="0" src="/rol/static/roc/Common_Content/images/11.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>An RFC 2255 URL, which specifies the LDAP host and maps the identity parameters in the LDAP database schema.
This <code class="code">url</code> value associates the user-supplied login credential with the specific entries in the LDAP server for identity lookups.</p></td></tr></tbody></table>
</div>

<pre class="screen fileinput">kind: LDAPSyncConfig
apiVersion: v1
url: ldap://example.com:389
insecure: false <a id="_ldap_sync_configuration_file-CO6-1"></a><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span>
rfc2307:
    groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    groupUIDAttribute: dn <a id="_ldap_sync_configuration_file-CO6-2"></a><span><img alt="2" border="0" src="/rol/static/roc/Common_Content/images/2.svg" class="image-previewer__preview "></span>
    groupNameAttributes: [ cn ] <a id="_ldap_sync_configuration_file-CO6-3"></a><span><img alt="3" border="0" src="/rol/static/roc/Common_Content/images/3.svg" class="image-previewer__preview "></span>
    groupMembershipAttributes: [ member ]
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    userUIDAttribute: dn <a id="_ldap_sync_configuration_file-CO6-4"></a><span><img alt="4" border="0" src="/rol/static/roc/Common_Content/images/4.svg" class="image-previewer__preview "></span>
    userNameAttributes: [ mail ] <a id="_ldap_sync_configuration_file-CO6-5"></a><span><img alt="5" border="0" src="/rol/static/roc/Common_Content/images/5.svg" class="image-previewer__preview "></span>
    tolerateMemberNotFoundErrors: false
    tolerateMemberOutOfScopeErrors: false</pre>

<div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td align="left" valign="top" width="5%"><p><a href="#_ldap_sync_configuration_file-CO6-1"><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>When true, no TLS connection is made to the server.
When false, <code class="code">ldaps://</code> URLs connect by using TLS, and <code class="code">ldap://</code> URLs are upgraded to TLS.
The <code class="code">insecure</code> option must be set to false when <code class="code">ldaps://</code> URLs are in use, because these URLs always attempt to connect by using TLS.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_ldap_sync_configuration_file-CO6-2"><span><img alt="2" border="0" src="/rol/static/roc/Common_Content/images/2.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The field that corresponds to the unique identifier field on the LDAP server for a group.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_ldap_sync_configuration_file-CO6-3"><span><img alt="3" border="0" src="/rol/static/roc/Common_Content/images/3.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The attribute for the name of the group.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_ldap_sync_configuration_file-CO6-4"><span><img alt="4" border="0" src="/rol/static/roc/Common_Content/images/4.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The field that corresponds the unique identifier field of the LDAP server for a user.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_ldap_sync_configuration_file-CO6-5"><span><img alt="5" border="0" src="/rol/static/roc/Common_Content/images/5.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The attribute for the name of the user.</p></td></tr></tbody></table></div>


<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_automating_ldap_group_synchronizations"></a>Automating LDAP Group Synchronizations</h3></div></div></div><p>LDAP group synchronizations are automated through the use of a cron job.
Configure this cron job from within a designated OpenShift project for this purpose.
Execute the job by using a service account with administrative access to the cluster to manage groups.</p><p>Start by creating the project for the cron job to run.
The following command creates a project named <code class="code">ldap-group-sync</code> for this purpose:</p><pre class="screen">[user@host ~]$ <strong class="userinput"><code>oc new-project ldap-group-sync</code></strong></pre><p>The client <code class="code">bindPassword</code> secret resource and the configuration map resource that are used during the configuration of the LDAP IdP are also needed for this task.
Additionally, create a service account with an appropriate cluster role and cluster role binding for the synchronization.
The following YAML code shows an example definition for creating a service account named <code class="code">ldap-group-sync-acct</code>:</p><pre class="screen fileinput">kind: ServiceAccount
apiVersion: v1
metadata:
  name: ldap-group-sync-acct
  namespace: ldap-group-sync</pre><p>Next, define a cluster role, as shown in the following example:</p><pre class="screen fileinput">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ldap-group-sync-acct
rules:
  - apiGroups:
      - ''  <a id="_automating_ldap_group_synchronizations-CO8-1"></a><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span>
      - user.openshift.io
    resources:
      - groups
    verbs:
      - get
      - list
      - create
      - update</pre><div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td align="left" valign="top" width="5%"><p><a href="#_automating_ldap_group_synchronizations-CO8-1"><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The core API group is identified by an empty string.</p></td></tr></tbody></table></div><p>Then, define a cluster role binding to bind the previous cluster role to the existing service account.</p><pre class="screen fileinput">kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ldap-group-sync-acct
subjects:
  - kind: ServiceAccount
    name: ldap-group-sync-acct
    namespace: ldap-group-sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ldap-group-sync-acct</pre><p>The cluster is configured to communicate with the LDAP IdP, and a service account is available to configure OpenShift groups from the LDAP group entities.
The following YAML code is an example configuration map file to specify the sync configuration:</p><pre class="screen fileinput">kind: ConfigMap
apiVersion: v1
metadata:
  name: ldap-group-sync-acct
  namespace: ldap-group-sync
data:
  sync.yaml: |
    kind: LDAPSyncConfig
    apiVersion: v1
    url: ldaps://1.2.3.4:389
    insecure: false
    bindDN: cn=administrator,dc=example,dc=com
    bindPassword:
      file: "/etc/secrets/bindPassword"
    ca: /etc/ldap-ca/ca.crt
    rfc2307:
      groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"
        scope: sub
        filter: "(objectClass=groupOfMembers)"
        derefAliases: never
        pageSize: 0
      groupUIDAttribute: dn
      groupNameAttributes: [ cn ]
      groupMembershipAttributes: [ member ]
      usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
      userUIDAttribute: dn
      userNameAttributes: [ uid ]
      tolerateMemberNotFoundErrors: false
      tolerateMemberOutOfScopeErrors: false</pre><p>Finally, define and deploy a cron job for the LDAP group synchronization.
The following YAML code is an example cron job definition that could be customized, such as by adapting the cron-specified schedule to meet business needs:</p><pre class="screen fileinput">kind: CronJob
apiVersion: batch/v1
metadata:
  name: ldap-group-sync-acct
  namespace: ldap-group-sync
spec:
  schedule: "&ZeroWidthSpace;*/30 * * * *&ZeroWidthSpace;" <a id="_automating_ldap_group_synchronizations-CO9-1"></a><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span>
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 0
      ttlSecondsAfterFinished: 1800 <a id="_automating_ldap_group_synchronizations-CO9-2"></a><span><img alt="2" border="0" src="/rol/static/roc/Common_Content/images/2.svg" class="image-previewer__preview "></span>
      template:
        spec:
          containers:
            - name: ldap-group-sync
              image: "registry.redhat.io/openshift4/ose-cli:latest"
              command:
                - "/bin/bash"
                - "-c"
                - "oc adm groups sync --sync-config=/etc/config/sync.yaml --confirm" <a id="_automating_ldap_group_synchronizations-CO9-3"></a><span><img alt="3" border="0" src="/rol/static/roc/Common_Content/images/3.svg" class="image-previewer__preview "></span>
              volumeMounts:
                - mountPath: "/etc/config"
                  name: "ldap-sync-volume"
                - mountPath: "/etc/secrets"
                  name: "ldap-bind-password"
                - mountPath: "/etc/ldap-ca"
                  name: "ldap-ca"
          volumes:
            - name: "ldap-sync-volume"
              configMap:
                name: "ldap-group-sync-acct"
            - name: "ldap-bind-password"
              secret:
                secretName: "ldap-secret" <a id="_automating_ldap_group_synchronizations-CO9-4"></a><span><img alt="4" border="0" src="/rol/static/roc/Common_Content/images/4.svg" class="image-previewer__preview "></span>
            - name: "ldap-ca"
              configMap:
                name: "ca-config-map"
          restartPolicy: "Never"
          terminationGracePeriodSeconds: 30
          activeDeadlineSeconds: 500
          dnsPolicy: "ClusterFirst"
          serviceAccountName: "ldap-group-sync-acct"</pre><div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td align="left" valign="top" width="5%"><p><a href="#_automating_ldap_group_synchronizations-CO9-1"><span><img alt="1" border="0" src="/rol/static/roc/Common_Content/images/1.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The defined schedule for the job in <code class="code">cron</code> format, to show every 30 minutes.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_automating_ldap_group_synchronizations-CO9-2"><span><img alt="2" border="0" src="/rol/static/roc/Common_Content/images/2.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The time, in seconds, to keep completed sync information, to correspond to the preceding cron schedule.</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_automating_ldap_group_synchronizations-CO9-3"><span><img alt="3" border="0" src="/rol/static/roc/Common_Content/images/3.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The LDAP group sync command to execute by using the sync configuration file that is defined in the configuration map.
<span class="bold"><strong>The <code class="code">oc adm groups sync</code> command is defined on a single line</strong></span>
</p></td></tr><tr><td align="left" valign="top" width="5%"><p><a href="#_automating_ldap_group_synchronizations-CO9-4"><span><img alt="4" border="0" src="/rol/static/roc/Common_Content/images/4.svg" class="image-previewer__preview "></span></a> </p></td><td align="left" valign="top"><p>The LDAP IdP <code class="code">bindDN</code> and <code class="code">bindPassword</code>.</p></td></tr></tbody></table></div><p>After the file is created, the configured cron job executes the group synchronization command during the specified schedule to ensure that consistent group configurations that are available from the LDAP IdP are added to the OpenShift cluster.
This job runs within the <code class="code">project</code> namespace, by using the service account, at an interval that the cron time spec defines in the <code class="code">CronJob</code> definition.</p><div class="note references"><h3 class="title">References</h3><p>For more information about integrating LDAP IdP for a RHOCP cluster, refer to the <span class="emphasis"><em>Configuring LDAP Identity Providers</em></span> section in the <span class="emphasis"><em>Authentication and Authorization</em></span> chapter in the Red&nbsp;Hat OpenShift Container Platform&nbsp;4.14 <span class="emphasis"><em>OpenShift Container Platform</em></span> documentation at <a class="ulink" href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/authentication_and_authorization/index#configuring-ldap-identity-provider" target="_top">https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/authentication_and_authorization/index#configuring-ldap-identity-provider</a>
</p><p>For more information about LDAP administration and the <code class="code">ldapsearch</code> command, refer to the Red&nbsp;Hat Directory Server documentation at <a class="ulink" href="https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html-single/administration_guide/index#Examples-of-common-ldapsearches" target="_top">https://access.redhat.com/documentation/en-us/red_hat_directory_server/11/html-single/administration_guide/index#Examples-of-common-ldapsearches</a>
</p></div><p></p></div>


